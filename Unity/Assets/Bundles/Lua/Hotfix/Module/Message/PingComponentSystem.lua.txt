-- Generated by CSharp.lua Compiler
local System = System
local ET = ET
System.namespace("ET", function (namespace)
  namespace.class("PingComponentAwakeSystem", function (namespace)
    local Awake, PingAsync, SessionPingAsync
    Awake = function (this, self)
      PingAsync(self):Coroutine()
    end
    PingAsync = function (self)
      return System.async(function (async, self)
        local session = self:GetParent(ET.Session)
        local instanceId = self.InstanceId

        while true do
          if self.InstanceId ~= instanceId then
            return
          end

          local default, extern = System.try(function ()
            --G2C_Ping response = await session.Call(self.C2G_Ping) as G2C_Ping;

            --if (self.InstanceId != instanceId)
            --{
            --    return;
            --}

            --long time2 = TimeHelper.ClientNow();
            --self.Ping = time2 - time1;

            --Game.TimeInfo.ServerMinusClientTime = response.Time + (time2 - time1) / 2 - time2;
            SessionPingAsync(self):Coroutine()

            async:Await(ET.TimerComponent.Instance:WaitAsync(2000))
          end, function (default)
            if System.is(default, ET.RpcException) then
              local e = default
              -- session断开导致ping rpc报错，记录一下即可，不需要打成error
              ET.Log.Info("ping error: " .. self.Id .. " " .. e.Error)
              return true
            else
              local e = default
              ET.Log.Error("ping error: \n" .. System.toString(e))
            end
          end)
          if default then
            return extern
          end
        end
      end, nil, self)
    end
    SessionPingAsync = function (self)
      return System.async(function (async, self)
        local time1 = ET.TimeHelper.ClientNow()
        local session = self:GetParent(ET.Session)
        local instanceId = self.InstanceId

        local response = System.as(async:Await(session:Call1(self.C2G_Ping)), ET.G2C_Ping)

        if self.InstanceId ~= instanceId then
          return
        end

        local time2 = ET.TimeHelper.ClientNow()
        self.Ping = time2 - time1

        ET.Game.getTimeInfo().ServerMinusClientTime = response.Time + System.div((time2 - time1), 2) - time2
      end, nil, self)
    end
    return {
      base = function (out)
        return {
          out.ET.AwakeSystem_1(out.ET.PingComponent)
        }
      end,
      Awake = Awake,
      __metadata__ = function (out)
        return {
          methods = {
            { "Awake", 0x106, Awake, out.ET.PingComponent },
            { "PingAsync", 0x189, PingAsync, out.ET.PingComponent, out.ET.ETVoid },
            { "SessionPingAsync", 0x189, SessionPingAsync, out.ET.PingComponent, out.ET.ETVoid }
          },
          class = { 0x6, out.ET.ObjectSystemAttribute() }
        }
      end
    }
  end)

  namespace.class("PingComponentDestroySystem", function (namespace)
    local Destroy
    Destroy = function (this, self)
      self.Ping = 0
    end
    return {
      base = function (out)
        return {
          out.ET.DestroySystem_1(out.ET.PingComponent)
        }
      end,
      Destroy = Destroy,
      __metadata__ = function (out)
        return {
          methods = {
            { "Destroy", 0x106, Destroy, out.ET.PingComponent }
          },
          class = { 0x6, out.ET.ObjectSystemAttribute() }
        }
      end
    }
  end)
end)
